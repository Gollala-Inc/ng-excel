import { ExcelRow } from './excel-row';
import { ExcelCell } from './excel-cell';
export class ExcelSheet {
    constructor(sheet, workbook, media) {
        this.sheet = sheet;
        this.workbook = workbook;
        this.media = media;
        this.name = '';
        this.cols = [];
        this.rows = [];
        this.rowCount = 0;
        this.images = [];
        this.name = sheet.name;
        let maxColumns = 0;
        let maxRows = 0;
        const merges = sheet._merges;
        const mergeCell = {};
        Object.keys(merges).forEach(key => {
            const { left, right, top, bottom } = merges[key].model;
            // maxColumns
            if (maxColumns < right) {
                maxColumns = right;
            }
            // maxRows
            if (maxRows < bottom) {
                maxRows = bottom;
            }
            // merge cell의 witdh, heigt 구하기
            let width = 0;
            let height = 0;
            let s_height = 0;
            for (let i = left; i <= right; i++) {
                if (!sheet.getColumn(i).hidden) {
                    width += sheet.getColumn(i).width || 8.34;
                }
            }
            for (let i = top; i <= bottom; i++) {
                if (!sheet.getRow(i).hidden) {
                    height += sheet.getRow(i).height || 15;
                    s_height += 23;
                }
            }
            mergeCell[key] = {
                width: width * 8,
                height: Math.round(height * 1.3),
                s_height: Math.round(s_height * 1.3)
            };
        });
        // rows
        /*sheet.eachRow((row, rowNumber) => {
          if (maxRows < rowNumber) {
            maxRows = rowNumber;
          }
          const cells: ExcelCell[] = [];
          for (let i = 1; i <= row.cellCount; i++) {
            if (maxColumns < i) {
              maxColumns = i;
            }
            let merge = false;
            let cell = (row.getCell(i).model as any);
            const cellNumber = i;
            let width: number = (sheet.getColumn(i).width || 8.34) * 8;
            let height: number = Math.round((row.height || 15) * 1.3);
            if (mergeCell[cell.address]) {
              width = mergeCell[cell.address].width;
              height = mergeCell[cell.address].height;
              merge = true;
            }
            const excelCell = new ExcelCell(cell.address, cellNumber, height, cell.style, width, cell.value, merge);
            cells.push(excelCell);
          }
    
          this.rows.push(new ExcelRow(rowNumber, row.hidden, Math.round((row.height || 15) * 1.3), cells));
          this.rowCount++;
        });*/
        for (let i = 0; i < sheet.rowCount; i++) {
            if (maxRows < i + 1) {
                maxRows = i + 1;
            }
            const row = sheet.getRow(i + 1);
            const cells = [];
            for (let i = 1; i <= row.cellCount; i++) {
                if (maxColumns < i) {
                    maxColumns = i;
                }
                let merge = false;
                let cell = row.getCell(i).model;
                const cellNumber = i;
                let width = (sheet.getColumn(i).width || 8.34) * 8;
                let height = Math.round((row.height || 15) * 1.3);
                let s_height = Math.round(23 * 1.3);
                if (mergeCell[cell.address]) {
                    width = mergeCell[cell.address].width;
                    height = mergeCell[cell.address].height;
                    s_height = mergeCell[cell.address].s_height;
                    merge = true;
                }
                const excelCell = new ExcelCell(cell.address, cellNumber, height, cell.style, width, cell.value, merge, s_height);
                cells.push(excelCell);
            }
            this.rows.push(new ExcelRow(i, row.hidden, Math.round((row.height || 15) * 1.3), cells, row));
            this.rowCount++;
        }
        // cols
        for (let i = 1; i <= sheet.columnCount; i++) {
            const { width, hidden } = sheet.getColumn(i);
            this.cols.push({
                width: (width || 8.34) * 8,
                hidden: hidden || false,
                name: this.getColumTitle(i - 1)
            });
        }
        // images 지금 상황에서 이미지 주문 고려안함, 차후 고려
        //this.getImages();
    }
    getColumTitle(index) {
        let title = '';
        if (Math.floor(index / 26) > 0) {
            title += String.fromCharCode(65 + Math.floor(index / 26) - 1);
        }
        title += String.fromCharCode(65 + index % 26);
        return title;
    }
    getImages() {
        const images = [];
        this.sheet.getImages().forEach(img => {
            const position = this.getImagePosition(img.range);
            images.push({
                col1: img.range.tl?.nativeCol,
                col2: img.range.br?.nativeCol,
                colOff1: img.range.tl?.nativeColOff,
                colOff2: img.range.br?.nativeColOff,
                row1: img.range.tl?.nativeRow,
                row2: img.range.br?.nativeRow,
                rowOff1: img.range.tl?.nativeRowOff,
                rowOff2: img.range.br?.nativeRowOff,
                image: this.getImage(+img.imageId),
                ext: img.range.ext,
                ...position
            });
        });
        this.images = images;
    }
    getImagePosition(range) {
        const result = {
            width: 0,
            height: 0,
            x: 0,
            y: 0,
            styleExpression: {}
        };
        // 시작점 찾기
        let aaa = 0;
        for (let i = 0; i < range.tl.nativeCol; i++) {
            if (!this.sheet.getColumn(i + 1)?.hidden) {
                result.x += (this.sheet.getColumn(i + 1)?.width || 8.34) * 8;
                // border 가 있기 때문에 1픽셀식 추가
                if (i > 0) {
                    result.x++;
                }
            }
        }
        for (let i = 0; i < range.tl.nativeRow; i++) {
            if (!this.sheet.getRow(i + 1)?.hidden) {
                result.y += Math.round((this.sheet.getRow(i + 1).height || 15) * 1.3);
                // border 가 있기 때문에 1픽셀식 추가
                if (i > 0) {
                    result.y++;
                }
            }
        }
        // 시작점 offset 추가
        result.x += range.tl.nativeColOff / 9525;
        result.y += range.tl.nativeRowOff / 9525;
        if (range.ext) {
            result.width = range.ext.width;
            result.height = range.ext.height;
        }
        else {
            // 끝점 찾기
            for (let i = range.tl.nativeCol; i < range.br.nativeCol; i++) {
                result.width += (this.sheet.getColumn(i + 1)?.width || 8.34) * 8;
            }
            console.log('tl.nativeRow', range.tl.nativeRow);
            for (let i = range.tl.nativeRow; i < range.br.nativeRow; i++) {
                result.height += Math.round((this.sheet.getRow(i + 1).height || 15) * 1.3);
            }
            // 끝점 offset 추가
            result.width += (range.br.nativeColOff / 9525) - (range.tl.nativeColOff / 9525);
            result.height += (range.br.nativeRowOff / 9525) - (range.tl.nativeRowOff / 9525);
        }
        result.styleExpression = { left: `${result.x}px`, top: `${result.y}px`, height: `${result.height}px`, width: `${result.width}px` };
        return result;
    }
    getImage(imageId) {
        /*const buffer = this.workbook.getImage(imageId).buffer;
        // @ts-ignore
        return btoa(buffer.reduce((data, byte) => data + String.fromCharCode(byte), ''));*/
        return this.media[imageId].base64;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhjZWwtc2hlZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1leGNlbC9zcmMvbGliL2NsYXNzL2V4Y2VsLXNoZWV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxhQUFhLENBQUM7QUFFckMsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGNBQWMsQ0FBQztBQTBCdkMsTUFBTSxPQUFPLFVBQVU7SUFTckIsWUFBb0IsS0FBZ0IsRUFBVSxRQUFrQixFQUFVLEtBQVk7UUFBbEUsVUFBSyxHQUFMLEtBQUssQ0FBVztRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFPO1FBUHRGLFNBQUksR0FBVyxFQUFFLENBQUM7UUFDbEIsU0FBSSxHQUFXLEVBQUUsQ0FBQztRQUNsQixTQUFJLEdBQWUsRUFBRSxDQUFDO1FBQ3RCLGFBQVEsR0FBVyxDQUFDLENBQUM7UUFDckIsV0FBTSxHQUFlLEVBQUUsQ0FBQztRQUl0QixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFFdkIsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztRQUdoQixNQUFNLE1BQU0sR0FBSSxLQUFhLENBQUMsT0FBTyxDQUFDO1FBQ3RDLE1BQU0sU0FBUyxHQUFRLEVBQUUsQ0FBQztRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNoQyxNQUFNLEVBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFDLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUVyRCxhQUFhO1lBQ2IsSUFBSSxVQUFVLEdBQUcsS0FBSyxFQUFFO2dCQUN0QixVQUFVLEdBQUcs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O0lBRU8sUUFBUSxDQUFDLE9BQWU7UUFDOUI7OzJGQUVtRjtRQUNuRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3BDLENBQUM7Q0FHRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RXhjZWxSb3d9IGZyb20gJy4vZXhjZWwtcm93JztcclxuaW1wb3J0IHtXb3Jrc2hlZXQsIE1lZGlhLCBXb3JrYm9vaywgSW1hZ2VSYW5nZX0gZnJvbSAnZXhjZWxqcyc7XHJcbmltcG9ydCB7RXhjZWxDZWxsfSBmcm9tICcuL2V4Y2VsLWNlbGwnO1xyXG5cclxuaW50ZXJmYWNlIENvbHMge1xyXG4gIHdpZHRoOiBudW1iZXI7XHJcbiAgaGlkZGVuOiBib29sZWFuO1xyXG4gIG5hbWU6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIEltYWdlIHtcclxuICBjb2wxOiBudW1iZXI7XHJcbiAgY29sMjogbnVtYmVyO1xyXG4gIGNvbE9mZjE6IG51bWJlcjtcclxuICBjb2xPZmYyOiBudW1iZXI7XHJcbiAgcm93MTogbnVtYmVyO1xyXG4gIHJvdzI6IG51bWJlcjtcclxuICByb3dPZmYxOiBudW1iZXI7XHJcbiAgcm93T2ZmMjogbnVtYmVyO1xyXG4gIGltYWdlOiBhbnk7XHJcbiAgd2lkdGg6IG51bWJlcjtcclxuICBoZWlnaHQ6IG51bWJlcjtcclxuICB4OiBudW1iZXI7XHJcbiAgeTogbnVtYmVyO1xyXG4gIGV4dDogYW55O1xyXG4gIHN0eWxlRXhwcmVzc2lvbjogYW55O1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRXhjZWxTaGVldCB7XHJcblxyXG4gIG5hbWU6IHN0cmluZyA9ICcnO1xyXG4gIGNvbHM6IENvbHNbXSA9IFtdO1xyXG4gIHJvd3M6IEV4Y2VsUm93W10gPSBbXTtcclxuICByb3dDb3VudDogbnVtYmVyID0gMDtcclxuICBpbWFnZXM6IEFycmF5PGFueT4gPSBbXTtcclxuXHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc2hlZXQ6IFdvcmtzaGVldCwgcHJpdmF0ZSB3b3JrYm9vazogV29ya2Jvb2ssIHByaXZhdGUgbWVkaWE6IGFueVtdKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBzaGVldC5uYW1lO1xyXG5cclxuICAgIGxldCBtYXhDb2x1bW5zID0gMDtcclxuICAgIGxldCBtYXhSb3dzID0gMDtcclxuXHJcblxyXG4gICAgY29uc3QgbWVyZ2VzID0gKHNoZWV0IGFzIGFueSkuX21lcmdlcztcclxuICAgIGNvbnN0IG1lcmdlQ2VsbDogYW55ID0ge307XHJcbiAgICBPYmplY3Qua2V5cyhtZXJnZXMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgY29uc3Qge2xlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbX0gPSBtZXJnZXNba2V5XS5tb2RlbDtcclxuXHJcbiAgICAgIC8vIG1heENvbHVtbnNcclxuICAgICAgaWYgKG1heENvbHVtbnMgPCByaWdodCkge1xyXG4gICAgICAgIG1heENvbHVtbnMgPSByaWdodDtcclxuICAgICAgfVxyXG4gICAgICAvLyBtYXhSb3dzXHJcbiAgICAgIGlmIChtYXhSb3dzIDwgYm90dG9tKSB7XHJcbiAgICAgICAgbWF4Um93cyA9IGJvdHRvbTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gbWVyZ2UgY2VsbOydmCB3aXRkaCwgaGVpZ3Qg6rWs7ZWY6riwXHJcbiAgICAgIGxldCB3aWR0aCA9IDA7XHJcbiAgICAgIGxldCBoZWlnaHQgPSAwO1xyXG4gICAgICBsZXQgc19oZWlnaHQgPSAwO1xyXG4gICAgICBmb3IgKGxldCBpID0gbGVmdDsgaSA8PSByaWdodDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKCFzaGVldC5nZXRDb2x1bW4oaSkuaGlkZGVuKSB7XHJcbiAgICAgICAgICB3aWR0aCArPSAoc2hlZXQuZ2V0Q29sdW1uKGkpLndpZHRoIGFzIG51bWJlcikgfHwgOC4zNDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgZm9yIChsZXQgaSA9IHRvcDsgaSA8PSBib3R0b207IGkrKykge1xyXG4gICAgICAgIGlmICghc2hlZXQuZ2V0Um93KGkpLmhpZGRlbikge1xyXG4gICAgICAgICAgaGVpZ2h0ICs9IChzaGVldC5nZXRSb3coaSkuaGVpZ2h0IGFzIG51bWJlcikgfHwgMTU7XHJcbiAgICAgICAgICBzX2hlaWdodCArPSAyMztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgbWVyZ2VDZWxsW2tleV0gPSB7XHJcbiAgICAgICAgd2lkdGg6IHdpZHRoICogOCxcclxuICAgICAgICBoZWlnaHQ6IE1hdGgucm91bmQoaGVpZ2h0ICogMS4zKSxcclxuICAgICAgICBzX2hlaWdodDogTWF0aC5yb3VuZChzX2hlaWdodCAqIDEuMylcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gcm93c1xyXG4gICAgLypzaGVldC5lYWNoUm93KChyb3csIHJvd051bWJlcikgPT4ge1xyXG4gICAgICBpZiAobWF4Um93cyA8IHJvd051bWJlcikge1xyXG4gICAgICAgIG1heFJvd3MgPSByb3dOdW1iZXI7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgY2VsbHM6IEV4Y2VsQ2VsbFtdID0gW107XHJcbiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHJvdy5jZWxsQ291bnQ7IGkrKykge1xyXG4gICAgICAgIGlmIChtYXhDb2x1bW5zIDwgaSkge1xyXG4gICAgICAgICAgbWF4Q29sdW1ucyA9IGk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBtZXJnZSA9IGZhbHNlO1xyXG4gICAgICAgIGxldCBjZWxsID0gKHJvdy5nZXRDZWxsKGkpLm1vZGVsIGFzIGFueSk7XHJcbiAgICAgICAgY29uc3QgY2VsbE51bWJlciA9IGk7XHJcbiAgICAgICAgbGV0IHdpZHRoOiBudW1iZXIgPSAoc2hlZXQuZ2V0Q29sdW1uKGkpLndpZHRoIHx8IDguMzQpICogODtcclxuICAgICAgICBsZXQgaGVpZ2h0OiBudW1iZXIgPSBNYXRoLnJvdW5kKChyb3cuaGVpZ2h0IHx8IDE1KSAqIDEuMyk7XHJcbiAgICAgICAgaWYgKG1lcmdlQ2VsbFtjZWxsLmFkZHJlc3NdKSB7XHJcbiAgICAgICAgICB3aWR0aCA9IG1lcmdlQ2VsbFtjZWxsLmFkZHJlc3NdLndpZHRoO1xyXG4gICAgICAgICAgaGVpZ2h0ID0gbWVyZ2VDZWxsW2NlbGwuYWRkcmVzc10uaGVpZ2h0O1xyXG4gICAgICAgICAgbWVyZ2UgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBleGNlbENlbGwgPSBuZXcgRXhjZWxDZWxsKGNlbGwuYWRkcmVzcywgY2VsbE51bWJlciwgaGVpZ2h0LCBjZWxsLnN0eWxlLCB3aWR0aCwgY2VsbC52YWx1ZSwgbWVyZ2UpO1xyXG4gICAgICAgIGNlbGxzLnB1c2goZXhjZWxDZWxsKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5yb3dzLnB1c2gobmV3IEV4Y2VsUm93KHJvd051bWJlciwgcm93LmhpZGRlbiwgTWF0aC5yb3VuZCgocm93LmhlaWdodCB8fCAxNSkgKiAxLjMpLCBjZWxscykpO1xyXG4gICAgICB0aGlzLnJvd0NvdW50Kys7XHJcbiAgICB9KTsqL1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaGVldC5yb3dDb3VudDsgaSsrKSB7XHJcbiAgICAgIGlmIChtYXhSb3dzIDwgaSsxKSB7XHJcbiAgICAgICAgbWF4Um93cyA9IGkrMTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCByb3cgPSBzaGVldC5nZXRSb3coaSsxKTtcclxuICAgICAgY29uc3QgY2VsbHM6IEV4Y2VsQ2VsbFtdID0gW107XHJcbiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHJvdy5jZWxsQ291bnQ7IGkrKykge1xyXG4gICAgICAgIGlmIChtYXhDb2x1bW5zIDwgaSkge1xyXG4gICAgICAgICAgbWF4Q29sdW1ucyA9IGk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBtZXJnZSA9IGZhbHNlO1xyXG4gICAgICAgIGxldCBjZWxsID0gKHJvdy5nZXRDZWxsKGkpLm1vZGVsIGFzIGFueSk7XHJcbiAgICAgICAgY29uc3QgY2VsbE51bWJlciA9IGk7XHJcbiAgICAgICAgbGV0IHdpZHRoOiBudW1iZXIgPSAoc2hlZXQuZ2V0Q29sdW1uKGkpLndpZHRoIHx8IDguMzQpICogODtcclxuICAgICAgICBsZXQgaGVpZ2h0OiBudW1iZXIgPSBNYXRoLnJvdW5kKChyb3cuaGVpZ2h0IHx8IDE1KSAqIDEuMyk7XHJcbiAgICAgICAgbGV0IHNfaGVpZ2h0OiBudW1iZXIgPSBNYXRoLnJvdW5kKDIzICogMS4zKTtcclxuICAgICAgICBpZiAobWVyZ2VDZWxsW2NlbGwuYWRkcmVzc10pIHtcclxuICAgICAgICAgIHdpZHRoID0gbWVyZ2VDZWxsW2NlbGwuYWRkcmVzc10ud2lkdGg7XHJcbiAgICAgICAgICBoZWlnaHQgPSBtZXJnZUNlbGxbY2VsbC5hZGRyZXNzXS5oZWlnaHQ7XHJcbiAgICAgICAgICBzX2hlaWdodCA9IG1lcmdlQ2VsbFtjZWxsLmFkZHJlc3NdLnNfaGVpZ2h0O1xyXG4gICAgICAgICAgbWVyZ2UgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBleGNlbENlbGwgPSBuZXcgRXhjZWxDZWxsKGNlbGwuYWRkcmVzcywgY2VsbE51bWJlciwgaGVpZ2h0LCBjZWxsLnN0eWxlLCB3aWR0aCwgY2VsbC52YWx1ZSwgbWVyZ2UsIHNfaGVpZ2h0KTtcclxuICAgICAgICBjZWxscy5wdXNoKGV4Y2VsQ2VsbCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMucm93cy5wdXNoKG5ldyBFeGNlbFJvdyhpLCByb3cuaGlkZGVuLCBNYXRoLnJvdW5kKChyb3cuaGVpZ2h0IHx8IDE1KSAqIDEuMyksIGNlbGxzLCByb3cpKTtcclxuICAgICAgdGhpcy5yb3dDb3VudCsrO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbHNcclxuICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHNoZWV0LmNvbHVtbkNvdW50OyBpKyspIHtcclxuICAgICAgY29uc3Qge3dpZHRoLCBoaWRkZW59ID0gc2hlZXQuZ2V0Q29sdW1uKGkpO1xyXG4gICAgICB0aGlzLmNvbHMucHVzaCh7XHJcbiAgICAgICAgd2lkdGg6ICh3aWR0aCB8fCA4LjM0KSAqIDgsXHJcbiAgICAgICAgaGlkZGVuOiBoaWRkZW4gfHwgZmFsc2UsXHJcbiAgICAgICAgbmFtZTogdGhpcy5nZXRDb2x1bVRpdGxlKGkgLSAxKVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBpbWFnZXMg7KeA6riIIOyDge2ZqeyXkOyEnCDsnbTrr7jsp4Ag7KO866y4IOqzoOugpOyViO2VqCwg7LCo7ZuEIOqzoOugpFxyXG4gICAgLy90aGlzLmdldEltYWdlcygpO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q29sdW1UaXRsZShpbmRleDogbnVtYmVyKSB7XHJcbiAgICBsZXQgdGl0bGUgPSAnJztcclxuICAgIGlmIChNYXRoLmZsb29yKGluZGV4IC8gMjYpID4gMCkge1xyXG4gICAgICB0aXRsZSArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDY1ICsgTWF0aC5mbG9vcihpbmRleCAvIDI2KSAtIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIHRpdGxlICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoNjUgKyBpbmRleCAlIDI2KTtcclxuICAgIHJldHVybiB0aXRsZTtcclxuICB9XHJcblxyXG4gIGdldEltYWdlcygpIHtcclxuICAgIGNvbnN0IGltYWdlczogSW1hZ2VbXSA9IFtdO1xyXG4gICAgdGhpcy5zaGVldC5nZXRJbWFnZXMoKS5mb3JFYWNoKGltZyA9PiB7XHJcbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5nZXRJbWFnZVBvc2l0aW9uKGltZy5yYW5nZSk7XHJcbiAgICAgIGltYWdlcy5wdXNoKHtcclxuICAgICAgICBjb2wxOiBpbWcucmFuZ2UudGw/Lm5hdGl2ZUNvbCxcclxuICAgICAgICBjb2wyOiBpbWcucmFuZ2UuYnI/Lm5hdGl2ZUNvbCxcclxuICAgICAgICBjb2xPZmYxOiBpbWcucmFuZ2UudGw/Lm5hdGl2ZUNvbE9mZixcclxuICAgICAgICBjb2xPZmYyOiBpbWcucmFuZ2UuYnI/Lm5hdGl2ZUNvbE9mZixcclxuICAgICAgICByb3cxOiBpbWcucmFuZ2UudGw/Lm5hdGl2ZVJvdyxcclxuICAgICAgICByb3cyOiBpbWcucmFuZ2UuYnI/Lm5hdGl2ZVJvdyxcclxuICAgICAgICByb3dPZmYxOiBpbWcucmFuZ2UudGw/Lm5hdGl2ZVJvd09mZixcclxuICAgICAgICByb3dPZmYyOiBpbWcucmFuZ2UuYnI/Lm5hdGl2ZVJvd09mZixcclxuICAgICAgICBpbWFnZTogdGhpcy5nZXRJbWFnZSgraW1nLmltYWdlSWQpLFxyXG4gICAgICAgIGV4dDogKGltZy5yYW5nZSBhcyBhbnkpLmV4dCxcclxuICAgICAgICAuLi5wb3NpdGlvblxyXG4gICAgICB9KVxyXG4gICAgfSk7XHJcbiAgICB0aGlzLmltYWdlcyA9IGltYWdlcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0SW1hZ2VQb3NpdGlvbihyYW5nZTogSW1hZ2VSYW5nZSkge1xyXG4gICAgY29uc3QgcmVzdWx0ID0ge1xyXG4gICAgICB3aWR0aDogMCxcclxuICAgICAgaGVpZ2h0OiAwLFxyXG4gICAgICB4OiAwLFxyXG4gICAgICB5OiAwLFxyXG4gICAgICBzdHlsZUV4cHJlc3Npb246IHt9XHJcbiAgICB9XHJcbiAgICAvLyDsi5zsnpHsoJAg7LC+6riwXHJcbiAgICBsZXQgYWFhID0gMDtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmFuZ2UudGwubmF0aXZlQ29sOyBpKyspe1xyXG4gICAgICBpZiAoIXRoaXMuc2hlZXQuZ2V0Q29sdW1uKGkrMSk/LmhpZGRlbikge1xyXG4gICAgICAgIHJlc3VsdC54ICs9ICh0aGlzLnNoZWV0LmdldENvbHVtbihpKzEpPy53aWR0aCB8fCA4LjM0KSAqIDhcclxuICAgICAgICAvLyBib3JkZXIg6rCAIOyeiOq4sCDrlYzrrLjsl5AgMe2UveyFgOyLnSDstpTqsIBcclxuICAgICAgICBpZiAoaSA+IDApIHtcclxuICAgICAgICAgIHJlc3VsdC54Kys7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJhbmdlLnRsLm5hdGl2ZVJvdzsgaSsrKXtcclxuICAgICAgaWYgKCF0aGlzLnNoZWV0LmdldFJvdyhpKzEpPy5oaWRkZW4pIHtcclxuICAgICAgICByZXN1bHQueSArPSBNYXRoLnJvdW5kKCh0aGlzLnNoZWV0LmdldFJvdyhpKzEpLmhlaWdodCB8fCAxNSkgKiAxLjMpO1xyXG4gICAgICAgIC8vIGJvcmRlciDqsIAg7J6I6riwIOuVjOusuOyXkCAx7ZS97IWA7IudIOy2lOqwgFxyXG4gICAgICAgIGlmIChpID4gMCkge1xyXG4gICAgICAgICAgcmVzdWx0LnkrKztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIOyLnOyekeygkCBvZmZzZXQg7LaU6rCAXHJcbiAgICByZXN1bHQueCArPSByYW5nZS50bC5uYXRpdmVDb2xPZmYgLyA5NTI1O1xyXG4gICAgcmVzdWx0LnkgKz0gcmFuZ2UudGwubmF0aXZlUm93T2ZmIC8gOTUyNTtcclxuXHJcbiAgICBpZiAoKHJhbmdlIGFzIGFueSkuZXh0KSB7XHJcbiAgICAgIHJlc3VsdC53aWR0aCA9IChyYW5nZSBhcyBhbnkpLmV4dC53aWR0aDtcclxuICAgICAgcmVzdWx0LmhlaWdodCA9IChyYW5nZSBhcyBhbnkpLmV4dC5oZWlnaHQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDrgZ3soJAg7LC+6riwXHJcbiAgICAgIGZvciAobGV0IGkgPSByYW5nZS50bC5uYXRpdmVDb2w7IGkgPCByYW5nZS5ici5uYXRpdmVDb2w7IGkrKykge1xyXG4gICAgICAgIHJlc3VsdC53aWR0aCArPSAodGhpcy5zaGVldC5nZXRDb2x1bW4oaSsxKT8ud2lkdGggfHwgOC4zNCkgKiA4XHJcbiAgICAgIH1cclxuICAgICAgY29uc29sZS5sb2coJ3RsLm5hdGl2ZVJvdycsIHJhbmdlLnRsLm5hdGl2ZVJvdyk7XHJcbiAgICAgIGZvciAobGV0IGkgPSByYW5nZS50bC5uYXRpdmVSb3c7IGkgPCByYW5nZS5ici5uYXRpdmVSb3c7IGkrKykge1xyXG4gICAgICAgIHJlc3VsdC5oZWlnaHQgKz0gTWF0aC5yb3VuZCgodGhpcy5zaGVldC5nZXRSb3coaSsxKS5oZWlnaHQgfHwgMTUpICogMS4zKTtcclxuICAgICAgfVxyXG4gICAgICAvLyDrgZ3soJAgb2Zmc2V0IOy2lOqwgFxyXG4gICAgICByZXN1bHQud2lkdGggKz0gKHJhbmdlLmJyLm5hdGl2ZUNvbE9mZiAvIDk1MjUpIC0gKHJhbmdlLnRsLm5hdGl2ZUNvbE9mZiAvIDk1MjUpO1xyXG4gICAgICByZXN1bHQuaGVpZ2h0ICs9IChyYW5nZS5ici5uYXRpdmVSb3dPZmYgLyA5NTI1KSAtIChyYW5nZS50bC5uYXRpdmVSb3dPZmYgLyA5NTI1KTtcclxuICAgIH1cclxuXHJcbiAgICByZXN1bHQuc3R5bGVFeHByZXNzaW9uID0ge2xlZnQ6IGAke3Jlc3VsdC54fXB4YCwgdG9wOiBgJHtyZXN1bHQueX1weGAsIGhlaWdodDogYCR7cmVzdWx0LmhlaWdodH1weGAsIHdpZHRoOiBgJHtyZXN1bHQud2lkdGh9cHhgfTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRJbWFnZShpbWFnZUlkOiBudW1iZXIpIHtcclxuICAgIC8qY29uc3QgYnVmZmVyID0gdGhpcy53b3JrYm9vay5nZXRJbWFnZShpbWFnZUlkKS5idWZmZXI7XHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICByZXR1cm4gYnRvYShidWZmZXIucmVkdWNlKChkYXRhLCBieXRlKSA9PiBkYXRhICsgU3RyaW5nLmZyb21DaGFyQ29kZShieXRlKSwgJycpKTsqL1xyXG4gICAgcmV0dXJuIHRoaXMubWVkaWFbaW1hZ2VJZF0uYmFzZTY0O1xyXG4gIH1cclxuXHJcblxyXG59XHJcbiJdfQ==